#include "pnn.h"

#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define CLASS_COUNT 3
#define PROPERTY_COUNT 39
#define MULTIHOP_COUNT 7
#define ROOTKIT_COUNT 10
#define SPY_COUNT 2

const char * PNN_FILENAME = "pnn-small";

static const double INPUT_MULTIHOP[MULTIHOP_COUNT][PROPERTY_COUNT] =
{
	{192.00,1.00,18.00,9.00,119.00,426.00,0.00,0.00,0.00,2.00,0.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,1.00,0.00,0.01,0.00,0.00,0.00,0.00,0.04,0.00},
	{179.00,1.00,18.00,9.00,87.00,319.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,2.00,0.01,0.01,0.00,0.00,0.00,0.00,0.04,0.00},
	{0.00,1.00,19.00,9.00,866.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,1.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00},
	{0.00,1.00,19.00,9.00,0.00,467968.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,2.00,2.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00},
	{1.00,1.00,19.00,9.00,0.00,988002.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,2.00,0.00,0.00,0.00,0.00,1.00,0.00,1.00,3.00,3.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00},
	{198.00,1.00,56.00,9.00,562.00,9139.00,0.00,0.00,0.00,3.00,0.00,1.00,22.00,1.00,0.00,39.00,4.00,2.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,1.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00},
	{718.00,1.00,56.00,9.00,1412.00,25260.00,0.00,0.00,0.00,15.00,0.00,1.00,38.00,1.00,0.00,54.00,4.00,1.00,2.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,1.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00}
};

static const double INPUT_ROOTKIT[ROOTKIT_COUNT][PROPERTY_COUNT] =
{
	{60.00,1.00,56.00,9.00,86.00,183.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,1.00,0.00,0.02,0.00,0.00,0.00,0.00,0.00,0.00},
	{60.00,1.00,56.00,9.00,90.00,233.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,2.00,0.01,0.02,0.00,0.00,0.00,0.00,0.00,0.00},
	{708.00,1.00,56.00,9.00,1727.00,24080.00,0.00,0.00,0.00,0.00,0.00,1.00,6.00,0.00,0.00,7.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,3.00,0.01,0.02,0.00,0.00,0.00,0.00,0.00,0.00},
	{21.00,1.00,18.00,9.00,89.00,345.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,1.00,0.00,0.02,0.00,0.00,0.00,0.00,0.00,0.00},
	{98.00,1.00,56.00,9.00,621.00,8356.00,0.00,0.00,1.00,1.00,0.00,1.00,5.00,1.00,0.00,14.00,1.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,4.00,0.02,0.02,0.00,0.00,0.00,0.00,0.00,0.00},
	{0.00,1.00,19.00,9.00,0.00,5636.00,0.00,0.00,0.00,0.00,0.00,1.00,2.00,0.00,0.00,2.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,41.00,1.00,0.00,1.00,0.10,0.00,0.00,0.00,0.00},
	{61.00,1.00,56.00,9.00,294.00,3929.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,4.00,1.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,4.00,0.02,0.02,0.00,0.00,0.00,0.25,0.73,0.25},
	{0.00,2.00,40.00,9.00,32.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,1.00,0.00,0.02,0.00,0.00,0.00,0.00,0.00,0.00},
	{0.00,2.00,40.00,9.00,4.00,4.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,1.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00},
	{0.00,2.00,40.00,9.00,4.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,2.00,2.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,2.00,2.00,1.00,0.00,0.50,0.00,0.00,0.00,0.00,0.00}
};

static const double INPUT_SPY[SPY_COUNT][PROPERTY_COUNT] =
{
	{337.00,1.00,56.00,9.00,237.00,1540.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,0.00,1.00,1.00,1.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,47.00,0.18,0.02,0.00,0.00,0.22,0.32,0.00,0.00},
	{299.00,1.00,56.00,9.00,112.00,847.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,255.00,48.00,0.19,0.02,0.00,0.00,0.22,0.31,0.00,0.00}
};

int test_pnn_predict()
{
	FILE * input; errno_t error;
	error = fopen_s(&input, PNN_FILENAME, "rb");
	if (input == NULL)
	{
		fprintf(stderr, "Error: can't open input; errno = %d\n", error);
		return 1;
	}

	pnn_data * net = pnn_data_load(input);
	fclose(input);

	time_t time_start, time_end;
	double time;
	pnn_prediction * prediction_arr;
	for (int i = 0; i < MULTIHOP_COUNT; i++)
	{
		time_start = clock();
		prediction_arr = pnn_predict(net, INPUT_MULTIHOP[i]);
		time_end = clock();
		time = ((double)(time_end - time_start)) / CLOCKS_PER_SEC;

		for (int j = 0; j < CLASS_COUNT; j++)
			printf("%s: %.2lf ", prediction_arr[j].class_name, prediction_arr[j].prediction);
		printf("\nTime: %lf\n", time);

		if (prediction_arr[0].prediction < 0.9)
		{
			free(prediction_arr);
			net = pnn_data_free(net);
			return 1;
		}

		free(prediction_arr);
	}
	for (int i = 0; i < ROOTKIT_COUNT; i++)
	{
		time_start = clock();
		prediction_arr = pnn_predict(net, INPUT_ROOTKIT[i]);
		time_end = clock();
		time = ((double)(time_end - time_start)) / CLOCKS_PER_SEC;

		for (int j = 0; j < CLASS_COUNT; j++)
			printf("%s: %.2lf ", prediction_arr[j].class_name, prediction_arr[j].prediction);
		printf("\nTime: %lf\n", time);

		if (prediction_arr[1].prediction < 0.9)
		{
			free(prediction_arr);
			net = pnn_data_free(net);
			return 1;
		}

		free(prediction_arr);
	}
	for (int i = 0; i < SPY_COUNT; i++)
	{
		time_start = clock();
		prediction_arr = pnn_predict(net, INPUT_SPY[i]);
		time_end = clock();
		time = ((double)(time_end - time_start)) / CLOCKS_PER_SEC;

		for (int j = 0; j < CLASS_COUNT; j++)
			printf("%s: %.2lf ", prediction_arr[j].class_name, prediction_arr[j].prediction);
		printf("\nTime: %lf\n", time);

		if (prediction_arr[2].prediction < 0.9)
		{
			free(prediction_arr);
			net = pnn_data_free(net);
			return 1;
		}

		free(prediction_arr);
	}

	net = pnn_data_free(net);

	return 0;
}